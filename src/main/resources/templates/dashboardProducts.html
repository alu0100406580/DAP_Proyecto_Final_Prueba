<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Lista de Productos</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/material-design-iconic-font/2.2.0/css/material-design-iconic-font.min.css">
    <link rel="stylesheet" th:href="@{/static/project.css}" />
    <style>
        #myGrid {
        width:100%;
        min-height: 500px;
        max-height: 700px;
    }
    .ag-center-cols-viewport {
        background-color: #EAFAE1
    }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/ag-grid-community/dist/ag-grid-community.min.js"></script>
</head>
<body>
<nav class="navbar navbar-expand-lg fixed-top navbar-scroll shadow-0" style="background-color: #ffede7;">
    <div class="container">
        <a class="navbar-brand" href="/">AhorroCesta</a>
        <div class="collapse navbar-collapse" id="navbarExample01">
            <ul class="navbar-nav me-auto mb-2 mb-lg-0">
                <li class="nav-item active">
                    <a class="nav-link px-3" th:href="@{/hiperdino/products}">Hiperdino</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link px-3" th:href="@{/mercadona/products}">Mercadona</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link px-3" th:href="@{/tutrebol/products}">Tu trebol</a>
                </li>
            </ul>
        </div>
    </div>
</nav>
<div class="content-container">
    <div class="row">
        <div class="col-md-8">
            <canvas id="barChartTotalHistoric"></canvas>
        </div>
        <div class="col-md-4">
            <canvas id="pieTotalShoppingChart"></canvas>
        </div>
    </div>
    <div class="row">
        <div class="col-md-4">
            <canvas id="hiperdinoHistoricChart"></canvas>
        </div>
        <div class="col-md-4">
            <canvas id="mercadonaHistoricChart"></canvas>
        </div>
        <div class="col-md-4">
            <canvas id="tuTrebolHistoricChart"></canvas>
        </div>
    </div>
    <div class="row">
        <div class="col-md-12">
            <div id="myGrid" class="ag-theme-quartz">
            </div>
        </div>
    </div>
</div>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script th:inline="javascript">
    var hiperdinoTotalBarData = /*[[${hiperdinoTotalChartData}]]*/ [];
    var mercadonaTotalBarData = /*[[${mercadonaTotalChartData}]]*/ [];
    var tuTrebolTotalBarData = /*[[${tuTrebolTotalChartData}]]*/ [];

    // Función para formatear la fecha de "YYYY-mm-dd" a "dd-mm-YYYY"
    function formatDate(inputDate) {
        var parts = inputDate.split('-');
        // Reorganizar las partes de la fecha
        var formattedDate = parts[2] + '-' + parts[1] + '-' + parts[0];
        return formattedDate;
    }

    // Obtener todas las etiquetas y formatearlas
    var allLabels = hiperdinoTotalBarData.labels.concat(mercadonaTotalBarData.labels, tuTrebolTotalBarData.labels);

    // Obtener el array con la mayor longitud
    var largestArray = hiperdinoTotalBarData.labels;
    if (mercadonaTotalBarData.labels && mercadonaTotalBarData.labels.length > largestArray.length) {
        largestArray = mercadonaTotalBarData.labels;
    }
    if (tuTrebolTotalBarData.labels && tuTrebolTotalBarData.labels.length > largestArray.length) {
        largestArray = tuTrebolTotalBarData.labels;
    }

    // Utilizar un conjunto (Set) para eliminar duplicados del array con la mayor longitud y luego convertirlo de nuevo a un array
    var uniqueLabels = Array.from(new Set(largestArray));

    // Ordenar el array por fecha
    var formattedLabels = uniqueLabels
      .map(formatDate)
      .sort(function(a, b) {
        var dateA = new Date(a.split('-').reverse().join('-'));
        var dateB = new Date(b.split('-').reverse().join('-'));
        return dateA - dateB;
      });

    var ctxHistoricChart = document.getElementById('barChartTotalHistoric').getContext('2d');

    // Crea el objeto de configuración del gráfico
        var historicChartConfig = {
            type: 'bar', // Tipo de gráfico (puedes cambiarlo según tus necesidades)
            data: {
                labels: formattedLabels,
                datasets: [{
                    label: 'Hiperdino',
                    data: hiperdinoTotalBarData.data,
                },
                {
                    label: 'Mercadona',
                    data: mercadonaTotalBarData.data,
                },
                {
                    label: 'Tu Trebol',
                    data: tuTrebolTotalBarData.data,
                }]
                // Puedes agregar más datasets si tienes más datos
            },
            options: {
                scales: {
                    y: {
                        beginAtZero: true
                    }
                },
                responsive: true,
                plugins: {
                  legend: {
                    position: 'top',
                  },
                  title: {
                    display: true,
                    text: 'HISTORICO COMPRA TOTAL'
                  }
                }
            }
        };
        // Crea el gráfico
        var myChart = new Chart(ctxHistoricChart, historicChartConfig);
</script>
<script th:inline="javascript">
    var hiperdinoTotalPieData = /*[[${hiperdinoTotalChartData}]]*/ [];
    var mercadonaTotalPieData = /*[[${mercadonaTotalChartData}]]*/ [];
    var tuTrebolTotalPieData = /*[[${tuTrebolTotalChartData}]]*/ [];

    var ctxTotalChart = document.getElementById('pieTotalShoppingChart').getContext('2d');

    // Crea el objeto de configuración del gráfico
        var totalChartConfig = {
            type: 'pie',
            data: {
                labels: [ 'Hiperdino', 'Mercadona', 'Tu Trebol'],
                datasets: [{
                    label: 'Totales',
                    data: [hiperdinoTotalPieData.data[0],mercadonaTotalPieData.data[0],tuTrebolTotalPieData.data[0]]
                }]
            },
            options: {
                responsive: true,
                plugins: {
                  legend: {
                    position: 'top',
                  },
                  title: {
                    display: true,
                    text: 'PORCENTAJE TOTAL DE COMPRA'
                  }
                }
            }
        };
        // Crea el gráfico
        var myChart = new Chart(ctxTotalChart, totalChartConfig);
</script>
<script th:inline="javascript">
    var rawProductsBySupermarketId = /*[[${rawProductsBySupermarketId}]]*/ [];
    var labelsFormattedDates = [];
    var datasets = [];

    var uniqueDatesSet = new Set();

    // Crear un array de fechas formateadas y almacenar valores únicos en el conjunto
    rawProductsBySupermarketId[1].forEach(function(item) {
        var rawDate = item.readAt;
        var dateObject = new Date(rawDate);

        // Formatear la fecha como "27-12-2023"
        var formattedDate = dateObject.getDate() + '-' + (dateObject.getMonth() + 1) + '-' + dateObject.getFullYear();

        uniqueDatesSet.add(formattedDate);
    });

    // Convertir el conjunto de fechas únicas en un array
    var labelsFormattedDates = Array.from(uniqueDatesSet);

    // Crear un objeto para almacenar datos agrupados por nombre de producto
    var groupedData = {};

    // Iterar sobre los datos y agrupar por nombre de producto
    rawProductsBySupermarketId[1].forEach(function(item) {
      var productName = item.product.name;

      if (!groupedData[productName]) {
        groupedData[productName] = {
          label: productName,
          data: []
        };
      }

      groupedData[productName].data.push(item.price);
    });

    // Convertir el objeto agrupado en un array de datasets
    var datasets = Object.values(groupedData);

    // Crea el objeto de configuración del gráfico
    var mercadonaChartConfig = {
        type: 'bar',
        data: {
            labels: labelsFormattedDates,
            datasets: datasets
        },
        options: {
            responsive: true,
            plugins: {
                legend: {
                    position: 'top',
                },
                title: {
                    display: true,
                    text: 'HISTORICO PRODUCTOS HIPERDINO'
                }
            }
        }
    };

    var ctxMercadonaChart = document.getElementById('hiperdinoHistoricChart').getContext('2d');

    // Crea el gráfico
    var myChart = new Chart(ctxMercadonaChart, mercadonaChartConfig);
</script>
<script th:inline="javascript">
    var rawProductsBySupermarketId = /*[[${rawProductsBySupermarketId}]]*/ [];
    var labelsFormattedDates = [];
    var datasets = [];

    var uniqueDatesSet = new Set();

    // Crear un array de fechas formateadas y almacenar valores únicos en el conjunto
    rawProductsBySupermarketId[2].forEach(function(item) {
        var rawDate = item.readAt;
        var dateObject = new Date(rawDate);

        // Formatear la fecha como "27-12-2023"
        var formattedDate = dateObject.getDate() + '-' + (dateObject.getMonth() + 1) + '-' + dateObject.getFullYear();

        uniqueDatesSet.add(formattedDate);
    });

    // Convertir el conjunto de fechas únicas en un array
    var labelsFormattedDates = Array.from(uniqueDatesSet);

    // Crear un objeto para almacenar datos agrupados por nombre de producto
    var groupedData = {};

    // Iterar sobre los datos y agrupar por nombre de producto
    rawProductsBySupermarketId[2].forEach(function(item) {
      var productName = item.product.name;

      if (!groupedData[productName]) {
        groupedData[productName] = {
          label: productName,
          data: []
        };
      }

      groupedData[productName].data.push(item.price);
    });

    // Convertir el objeto agrupado en un array de datasets
    var datasets = Object.values(groupedData);

    // Crea el objeto de configuración del gráfico
    var mercadonaChartConfig = {
        type: 'bar',
        data: {
            labels: labelsFormattedDates,
            datasets: datasets
        },
        options: {
            responsive: true,
            plugins: {
                legend: {
                    position: 'top',
                },
                title: {
                    display: true,
                    text: 'HISTORICO PRODUCTOS MERCADONA'
                }
            }
        }
    };

    var ctxMercadonaChart = document.getElementById('mercadonaHistoricChart').getContext('2d');

    // Crea el gráfico
    var myChart = new Chart(ctxMercadonaChart, mercadonaChartConfig);
</script>
<script th:inline="javascript">
    var rawProductsBySupermarketId = /*[[${rawProductsBySupermarketId}]]*/ [];
    var labelsFormattedDates = [];
    var datasets = [];

    var uniqueDatesSet = new Set();

    // Crear un array de fechas formateadas y almacenar valores únicos en el conjunto
    rawProductsBySupermarketId[3].forEach(function(item) {
        var rawDate = item.readAt;
        var dateObject = new Date(rawDate);

        // Formatear la fecha como "27-12-2023"
        var formattedDate = dateObject.getDate() + '-' + (dateObject.getMonth() + 1) + '-' + dateObject.getFullYear();

        uniqueDatesSet.add(formattedDate);
    });

    // Convertir el conjunto de fechas únicas en un array
    var labelsFormattedDates = Array.from(uniqueDatesSet);

    // Crear un objeto para almacenar datos agrupados por nombre de producto
    var groupedData = {};

    // Iterar sobre los datos y agrupar por nombre de producto
    rawProductsBySupermarketId[3].forEach(function(item) {
      var productName = item.product.name;

      if (!groupedData[productName]) {
        groupedData[productName] = {
          label: productName,
          data: []
        };
      }

      groupedData[productName].data.push(item.price);
    });

    // Convertir el objeto agrupado en un array de datasets
    var datasets = Object.values(groupedData);

    // Crea el objeto de configuración del gráfico
    var mercadonaChartConfig = {
        type: 'bar',
        data: {
            labels: labelsFormattedDates,
            datasets: datasets
        },
        options: {
            responsive: true,
            plugins: {
                legend: {
                    position: 'top',
                },
                title: {
                    display: true,
                    text: 'HISTORICO PRODUCTOS TU TREBOL'
                }
            }
        }
    };

    var ctxMercadonaChart = document.getElementById('tuTrebolHistoricChart').getContext('2d');

    // Crea el gráfico
    var myChart = new Chart(ctxMercadonaChart, mercadonaChartConfig);
</script>
<script th:inline="javascript">
    var selectedProducts = /*[[${selectedProducts}]]*/ [];

    const rowData = selectedProducts.map(product => ({
        Supermercado: product.supermarket.name,
        Nombre: product.product.name,
        "Precio Unidad": product.product.price.toFixed(2),
        Cantidad: product.quantity,
        Total: (product.product.price * product.quantity).toFixed(2)
    }));

    const gridOptions = {
        rowData: rowData,
        columnDefs: [
            { field: "Supermercado", filter: 'agTextColumnFilter' }, // Agrega filtro de texto para Supermercado
            { field: "Nombre", filter: 'agTextColumnFilter', flex: 1 }, // Agrega filtro de texto para Nombre
            { field: "Precio Unidad" },
            { field: "Cantidad" },
            { field: "Total" }
        ],
        // Configura la cuadrícula para ser scrolleable si supera 10 filas
        domLayout: 'autoHeight',
        defaultColDef: {
            cellStyle: { backgroundColor: '#EAFAE1' } // Reemplaza "yourColor" con el color que desees
        }
    };

    const myGridElement = document.querySelector('#myGrid');
    new agGrid.Grid(myGridElement, gridOptions);
</script>
</body>
</html>